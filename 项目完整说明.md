# AI智能体项目完整说明

## 项目概述

这是一个基于Ollama的AI智能体软件，主要功能包括：
- 获取实时天气信息
- 获取热点新闻
- 基于城市相关程度对新闻进行排序和标注
- 与AI讨论特定新闻内容
- 生成AI智能汇总报告

## 核心功能

### 1. 天气信息获取
- 支持指定城市查询天气
- 显示温度、湿度、风速等详细信息
- 自动更新天气数据
- **新增：地区标注显示，清晰标识信息所属城市**

### 2. 新闻获取与智能排序
- 获取实时热点新闻
- **新增：按城市相关程度自动排序**
- **新增：每条新闻显示相关程度标签**
- **新增：地区标注显示，明确标识新闻所属地区**
- 支持20个主要城市的关键词匹配
- 相关程度分为：高度相关、相关、一般相关、一般

### 3. 新闻讨论功能 ⭐ 新功能
- **支持与AI讨论特定新闻**
- **自动抓取新闻网页内容**
- **基于新闻内容进行深度分析**
- **支持持续性对话和对话历史管理**
- **基于前序问答进行补充和深化**
- 支持多种问题类型：影响分析、原因分析、趋势预测等
- 提供专业的新闻分析回复
- **删除思考过程，直接输出结果**

### 4. AI智能汇总
- 结合天气和新闻信息生成汇总报告
- 支持Markdown格式输出
- 去除思维链信息，提供简洁明了的分析
- 按城市相关程度筛选新闻
- **新增：地区标注显示，明确标识汇总所属城市**
- **新增：字符串匹配过滤，去除<think>标签和思考关键词**

### 5. 自动刷新功能 ⭐ 新功能
- **地区更新后自动刷新所有信息**
- **并行获取天气、新闻和AI汇总**
- **支持回车键快速切换城市**
- **页面加载时自动加载默认城市信息**
- **实时反馈更新状态**

### 6. 思考内容过滤功能 ⭐ 新功能
- **字符串匹配过滤，去除AI回复中的思考内容**
- **支持<think>和<thinking>标签过滤**
- **过滤常见思考关键词和过渡语句**
- **应用于AI汇总和新闻讨论功能**
- **保持内容完整性，只去除思考过程**

## 技术架构

### 后端技术栈
- **Flask**: Python Web框架，提供API接口
- **Ollama**: 本地大语言模型推理引擎
- **requests**: HTTP请求库，用于获取外部API数据
- **BeautifulSoup4**: HTML解析库，用于新闻内容抓取
- **正则表达式**: 用于思考内容过滤和文本处理

### 前端技术栈
- **HTML5/CSS3**: 页面结构和样式
- **JavaScript**: 交互逻辑和动态内容
- **Bootstrap**: UI框架，提供响应式设计
- **Font Awesome**: 图标库

### 核心服务模块
- **WeatherService**: 天气信息获取服务
- **NewsService**: 新闻获取和相关性分析服务
- **OllamaService**: AI模型调用和内容生成服务
- **思考内容过滤**: 字符串匹配过滤，去除AI回复中的思考过程

#### 1. 新闻服务 (`services/news_service.py`)
```python
# 主要功能
- get_news(limit, city): 获取新闻并按相关程度排序
- get_news_content(url): 抓取新闻网页内容
- _calculate_relevance(news, city): 计算新闻相关程度
- analyze_news_relevance(news_list, city): 分析新闻相关性
```

#### 2. AI服务 (`services/ollama_service.py`)
```python
# 主要功能
- generate_summary(weather, news, city): 生成AI汇总
- discuss_news(content, question, title): 新闻讨论功能
- _build_discussion_prompt(): 构建讨论提示词
```

#### 3. 天气服务 (`services/weather_service.py`)
```python
# 主要功能
- get_weather(city): 获取城市天气信息
- 支持多种天气数据源
```

## API接口

### 1. 新闻相关接口
```
GET /api/news?city=北京&limit=10
- 获取新闻，支持按城市相关程度排序

GET /api/news-content?url=新闻链接
- 获取新闻网页内容

POST /api/discuss-news
- 与AI讨论特定新闻
- 请求体: {"url": "新闻链接", "question": "问题"}
```

### 2. 其他接口
```
GET /api/weather?city=城市名
- 获取天气信息

GET /api/summary?city=城市名
- 获取AI汇总报告

GET /api/models
- 获取可用Ollama模型

POST /api/set-model
- 设置使用的模型
```

## 新闻相关程度算法

### 相关程度计算
1. **关键词匹配**: 基于城市关键词库进行匹配
2. **权重分配**: 
   - 标题匹配: 3分
   - 摘要匹配: 1分
3. **相关级别划分**:
   - 高度相关: ≥6分
   - 相关: ≥3分
   - 一般相关: ≥1分
   - 一般: 0分

### 支持的城市
北京、上海、广州、深圳、杭州、南京、成都、重庆、武汉、西安、天津、青岛、大连、厦门、苏州、无锡、宁波、长沙、郑州、济南

## 新闻讨论功能详解

### 功能特点
1. **智能内容抓取**: 自动从新闻链接中提取正文内容
2. **多选择器支持**: 支持多种网页结构的内容提取
3. **内容清理**: 自动去除广告、无关信息
4. **AI深度分析**: 基于新闻内容进行专业分析
5. **持续性对话**: 支持多轮对话，保持上下文连贯性
6. **对话历史管理**: 自动保存和管理对话历史
7. **基于前序问答补充**: AI能够基于之前的对话进行补充和深化
8. **删除思考过程**: 去除AI的思考过程，直接输出结果

### 使用流程
1. 用户点击新闻旁的讨论按钮
2. 系统自动抓取新闻内容
3. 用户输入问题
4. AI基于新闻内容和对话历史进行分析回复
5. 用户可以继续提问，AI会基于前序对话进行补充
6. 支持清除对话历史重新开始

### 支持的问题类型
- 影响分析: "这条新闻的主要影响是什么？"
- 原因分析: "为什么会发生这样的事情？"
- 趋势预测: "未来发展趋势如何？"
- 深度解读: "请详细分析这条新闻的背景"
- 基于前序问答: "基于前面的讨论，这种趋势会持续吗？"
- 具体分析: "请详细分析XX公司的成功经验"

### 持续性对话特性
1. **会话管理**: 每个新闻讨论都有独立的会话ID
2. **历史记录**: 自动保存最近10轮对话历史
3. **上下文理解**: AI能够理解前序对话的上下文
4. **渐进式分析**: 支持从浅入深的渐进式分析
5. **历史清除**: 用户可以随时清除对话历史重新开始

### 技术实现
- **会话ID生成**: 基于时间戳和随机数生成唯一会话ID
- **对话历史存储**: 服务器端存储对话历史，支持多用户并发
- **历史长度限制**: 自动限制对话历史长度，避免性能问题
- **上下文传递**: 将对话历史作为上下文传递给AI模型

## 安装与部署

### 环境要求
- Python 3.8+
- Ollama (本地大语言模型)
- 网络连接

### 安装步骤
1. 克隆项目
2. 安装依赖: `pip install -r requirements.txt`
3. 安装Ollama: 运行 `install_ollama.bat`
4. 启动应用: `python app.py`

### 快速启动
```bash
# 使用启动脚本
python start_ai.py

# 或直接启动
python app.py
```

## 使用说明

### 基本使用
1. 打开浏览器访问 `http://localhost:5000`
2. 输入城市名称（支持自动补全）
3. 选择Ollama模型
4. 点击"生成AI汇总"获取报告
5. **新增：地区更新后会自动刷新所有信息**

### 自动刷新功能
1. **输入城市名称**：在输入框中输入或选择城市
2. **回车键确认**：按回车键快速切换城市
3. **自动刷新**：系统会自动并行获取该城市的天气、新闻和AI汇总
4. **实时反馈**：显示更新进度和结果状态
5. **地区标注**：所有信息都会显示所属城市标识

### 新闻讨论功能
1. 在新闻列表中找到感兴趣的新闻
2. 点击新闻旁的"💬"按钮
3. 在弹出的对话框中输入问题
4. 点击"提交讨论"获取AI回复
5. **可以继续提问，AI会基于前序对话进行补充**
6. **支持查看对话历史和清除历史记录**

### 相关程度说明
- 🔥 高度相关: 与指定城市高度相关的新闻
- ⭐ 相关: 与指定城市相关的新闻
- 📌 一般相关: 与指定城市有一定相关性的新闻
- 🔗 一般: 普通新闻

## 故障排除

### 常见问题
1. **Ollama连接失败**: 检查Ollama服务是否启动
2. **新闻获取失败**: 检查网络连接
3. **内容抓取失败**: 某些网站可能有反爬虫机制
4. **模型加载失败**: 检查Ollama模型是否已下载

### 解决方案
- 查看控制台错误信息
- 检查网络连接
- 重启Ollama服务
- 尝试不同的新闻链接

## 项目结构
```
AI-Agent/
├── app.py                 # Flask主应用
├── services/              # 服务模块
│   ├── news_service.py    # 新闻服务
│   ├── ollama_service.py  # AI服务
│   └── weather_service.py # 天气服务
├── templates/             # 前端模板
│   └── index.html         # 主页面
├── requirements.txt       # 依赖列表
├── start_ai.py           # 启动脚本
└── README.md             # 项目说明
```

## 更新日志

### v2.0 (最新版本)
- ✅ 新增新闻讨论功能
- ✅ 新增新闻相关程度标注
- ✅ 新增新闻按相关程度排序
- ✅ 新增新闻内容自动抓取
- ✅ 优化AI回复质量
- ✅ 改进用户界面

### v1.0
- ✅ 基础天气查询功能
- ✅ 基础新闻获取功能
- ✅ AI汇总功能
- ✅ 模型选择功能

## 技术特色

1. **智能排序**: 基于城市相关程度的新闻智能排序
2. **内容抓取**: 自动抓取新闻网页内容进行分析
3. **AI对话**: 支持与AI进行新闻深度讨论
4. **本地部署**: 基于Ollama的本地AI推理
5. **实时更新**: 支持实时天气和新闻数据
6. **用户友好**: 直观的Web界面和交互体验

## 未来规划

- [ ] 支持更多新闻源
- [ ] 增加新闻情感分析
- [ ] 支持多语言新闻
- [ ] 增加新闻推荐算法
- [ ] 支持新闻订阅功能
- [ ] 增加移动端适配

---

**项目维护者**: AI智能体开发团队  
**最后更新**: 2024年8月4日  
**版本**: v2.0 